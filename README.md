# npm Trusted Publisher Tools

> **Note**: This entire repository was generated by [Claude Code](https://claude.ai/claude-code). Use at your own risk and review the code before using in production.

Tools to automate npm trusted publisher configuration for GitHub Actions OIDC.

## Overview

npm's [Trusted Publisher](https://docs.npmjs.com/generating-provenance-statements#publishing-packages-with-provenance-via-github-actions) feature allows publishing packages from GitHub Actions without storing npm tokens as secrets. Instead, it uses OpenID Connect (OIDC) to verify the package is being published from an authorized workflow.

Setting this up for each package manually is tedious. These tools automate the process.

## Chrome Extension

A Chrome extension that automates filling the trusted publisher form on npmjs.com.

### Why an Extension?

Unlike automated scripts (Playwright, Puppeteer), this extension runs in your real browser session:

- **No bot detection** - Uses your authenticated npm session directly
- **No login automation needed** - You're already logged in
- **OTP handling** - You handle 2FA/OTP manually in your normal browser
- **Reliable** - No fighting with anti-automation measures

### Installation

1. Open Chrome and navigate to `chrome://extensions`
2. Enable "Developer mode" (toggle in top right)
3. Click "Load unpacked"
4. Select the `extension/` directory

### Usage

1. **Log into npm** - Open npmjs.com and log in normally (if not already)

2. **Open the extension** - Click the extension icon in Chrome toolbar

3. **Configure GitHub settings**:
   - **Repository Owner**: Your GitHub org/user (e.g., `dxos`)
   - **Repository Name**: Your repo name (e.g., `dxos`)
   - **Workflow Filename**: The workflow that publishes (e.g., `publish.yml`)
   - **Environment**: Optional GitHub environment name

4. **Choose options**:
   - **Navigation Mode**:
     - *Manual* - Click "Next" after each package (recommended for OTP)
     - *Auto* - Automatically advances after detecting success
   - **Form Submission**:
     - *Semi-auto* - Extension fills form, you click submit
     - *Auto* - Extension also clicks submit button
   - **Delay**: Seconds between packages (for auto mode)

5. **Enter package list** - One package per line:
   ```
   @myorg/package-a
   @myorg/package-b
   @myorg/package-c
   ```

6. **Click "Start"** - The extension will:
   - Navigate to the first package's access page
   - Fill in the trusted publisher form
   - Wait for you to submit and handle OTP (in semi-auto mode)
   - Detect success and advance to next package
   - Skip packages that are already configured
   - Skip packages that don't exist (404)

### Features

- **Auto-skip configured packages** - Detects if trusted publisher is already set up
- **Auto-skip 404s** - Skips packages that aren't published yet
- **Progress tracking** - See completed/skipped/failed/pending counts
- **Pause/Resume** - Stop and continue later (state persists in Chrome storage)
- **Fill Current Page** - Manually fill any npm package access page

### Tips

- Use **Manual navigation + Semi-auto submission** for safest operation
- The extension only works on `https://www.npmjs.com/package/*/access` pages
- If a package fails, you can manually fix it and click "Next"
- State persists across browser restarts

## Helper Scripts

### Check Unpublished Packages

Find packages in your monorepo that aren't published to npm yet:

```bash
node scripts/check-unpublished.mjs
```

This script:
1. Lists all non-private packages in your monorepo (using `pnpm --filter-prod`)
2. Checks each against the npm registry
3. Outputs unpublished packages
4. Saves list to `unpublished-packages.txt`

**Note**: Run this from your monorepo root directory.

### Publish Unpublished Packages

Publish packages from a list, using 1Password for OTP:

```bash
./scripts/publish-unpublished.sh [packages-file]
```

Default packages file is `unpublished-packages.txt`.

**Configuration**: Edit the script to set your 1Password credentials:

```bash
NPM_1P_UUID="your-npm-item-uuid"        # 1Password item UUID containing npm OTP
NPM_1P_ACCOUNT="your-1password-account" # 1Password account ID
SLEEP_SECONDS=5                          # Delay between publishes
```

**Features**:
- Gets fresh OTP from 1Password for each publish
- Continues on failure (doesn't stop the whole batch)
- Shows summary at the end with succeeded/failed counts
- Lists failed packages for easy retry

**Prerequisites**:
- [1Password CLI](https://1password.com/downloads/command-line/) installed and authenticated
- npm login (`npm login`)
- pnpm installed

## Workflow

### Setting Up Trusted Publisher for a Monorepo

1. **Find unpublished packages** (from monorepo root):
   ```bash
   node path/to/scripts/check-unpublished.mjs
   ```

2. **Publish unpublished packages** (they need to exist on npm first):
   ```bash
   ./path/to/scripts/publish-unpublished.sh
   ```

3. **Get list of all packages for the extension**:
   ```bash
   pnpm --filter-prod="./packages/**" list --json | jq -r '.[].name' | pbcopy
   ```

4. **Configure trusted publisher** using the Chrome extension:
   - Paste package list into extension
   - Configure GitHub settings
   - Click Start and handle OTP prompts

5. **Update your GitHub Actions workflow** to use OIDC:
   ```yaml
   permissions:
     contents: read
     id-token: write  # Required for npm provenance

   jobs:
     publish:
       steps:
         - run: pnpm publish --provenance --access public
   ```

### Adding New Packages Later

1. Publish the new package (first publish requires npm token or OTP)
2. Navigate to the package's access page on npmjs.com
3. Use the extension's "Fill Current Page" button
4. Submit and enter OTP
5. Future publishes use OIDC automatically

## License

MIT
